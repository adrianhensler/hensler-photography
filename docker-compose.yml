# Production Docker Compose
# Serves all 3 domains on standard HTTPS (port 443)
# Includes /admin and /manage routes on each domain
# Caddy automatically manages TLS certificates for each domain

services:
  web:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "4001:4001"  # Protected sites range (gptresearcher)
    volumes:
      - ./sites:/srv/sites:ro
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - /opt/prod/gptresearcher/gpt-researcher/outputs:/srv/gptresearcher/outputs:ro
      - gallery-images:/srv/assets/gallery:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - default
      - gpt-researcher_default

  # API service
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    restart: unless-stopped
    # API endpoints proxied through Caddy with SSL
    volumes:
      - gallery-db:/data
      - gallery-images:/app/assets/gallery
    environment:
      - DATABASE_PATH=/data/gallery.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

networks:
  default:
  gpt-researcher_default:
    external: true

volumes:
  caddy-data:
  caddy-config:
  # Database and images volumes
  gallery-db:
  gallery-images:
