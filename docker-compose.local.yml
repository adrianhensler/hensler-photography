# Local Development Docker Compose
# Port 8080: All routes (mirrors production architecture)
#   https://hensler.photography:8080          (main site)
#   https://liam.hensler.photography:8080     (Liam's site)
#   https://adrian.hensler.photography:8080   (Adrian's site)
#   https://adrian.hensler.photography:8080/manage  (Management interface)
#   https://adrian.hensler.photography:8080/admin   (Admin login)
#
# Usage: docker compose -p hensler_test -f docker-compose.local.yml up -d

services:
  web:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "8080:8080"  # All routes on same port (public + admin)
    volumes:
      - ./sites:/srv/sites:ro
      - ./Caddyfile.local:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - gallery-images:/srv/assets/gallery:ro
    networks:
      - hensler-network
    depends_on:
      - api

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_PATH: /data/gallery.db
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      CSRF_SECRET_KEY: ${CSRF_SECRET_KEY}
    volumes:
      - ./api:/app/api:ro
      - gallery-data:/data
      - gallery-images:/app/assets/gallery
      - ./sites:/srv/sites
    networks:
      - hensler-network
    # Not exposed to host, only accessible through Caddy reverse proxy

volumes:
  caddy-data:
    external: true
    name: hensler_photography_caddy-data
  caddy-config:
    external: true
    name: hensler_photography_caddy-config
  gallery-data:
    # SQLite database and metadata
  gallery-images:
    # Uploaded and processed images

networks:
  hensler-network:
    driver: bridge
